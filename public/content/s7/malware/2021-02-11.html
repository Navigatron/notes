<!DOCTYPE html>
<html lang=" en-US">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		
	<!-- MathJax disabled on this page -->

		


		<!--[if lt IE 9]>
			<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
		<![endif]-->
		
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Arvo&family=Fira+Mono&family=Open+Sans&display=swap');
		</style>
		<link rel="stylesheet" href="/styles/index.css?v=1657689426779">

		<!-- Code Highlighting -->
		<link rel="stylesheet" href="https://raw.githubusercontent.com/PrismJS/prism-themes/master/themes/prism-one-light.css">
	</head>

	<body>
		<main>
			
			


<article>
	<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; Wed Feb 10 2021 19:00:00 GMT-0500 (Eastern Standard Time):</p>
<h1>Wed Feb 10 2021 19:00:00 GMT-0500 (Eastern Standard Time):</h1>
<h2>A quick review</h2>
<p>Process Injection can happen via:</p>
<ul>
<li>DLL Injection
<ul>
<li>Tell the target process to load an evil DLL</li>
<li>Generally easier</li>
<li>More common</li>
<li>When the DLL is loaded, the OS automatically calls the <code>DLLMain</code> function</li>
</ul>
</li>
<li>Direct Injection
<ul>
<li>Inject the malware directly into the memory of the target</li>
<li>Very hard</li>
</ul>
</li>
</ul>
<h1>Process Replacement</h1>
<p>Malware authors could crash the target process if they try direct injection. There is less risk of crash if the target process is completely replaced.</p>
<p>The target process should be something that very few things depend on. Otherwise, things could go wrong when the malware takes away functionality.</p>
<p><code>SVChost.exe</code> is a great target, as it contains a bunch of independent things. A new svchost likely won't be noticed.</p>
<p>Where DLL injection puts malware into an existing process, process replacement starts a new process containing evil code.</p>
<ul>
<li>New process is created in a suspended state
<ul>
<li>flag CREATE_SUSPENDED (0x4)</li>
</ul>
</li>
<li>Process is overwritten</li>
<li>Process is allowed to get going</li>
</ul>
<pre><code class="language-c">// Start a new process in suspended state
CreateProcess(..., &quot;svchost.exe&quot;, ..., CREATE_SUSPEND, ...)

// Clear the entire process memory - no artifacts!
// Once it's clear, we can write over it.
zUnmapViewOfSection(...);

// Allocate space, equal to the size of *this* binary
// What does ImageBase do?
VirtualAllocEx(..., ImageBase, sizeOfImage, ...);

// What does this do?
// Why do we need to do this?
WriteProcessMemory(..., headers, ...);

// Copy over our own sections
for (i=0; i&lt;sections; i++){
	WriteProcessMemory(section);
}

// Sets the starting point of the new process to the beginning
// Of its fresh new contents
SetThreadContext();

// Go run free, new process!
ResumeThread();
</code></pre>
<blockquote>
<p>0x4d 0x5a =&gt; &quot;MZ&quot;, at the start of windows executable binaries</p>
</blockquote>
<p>&quot;PEView&quot; is a static analysis tool that will lay out all the sections of a binary.</p>
<p>Next class, we'll finish up this section and jump right into lab 2.</p>
<hr>
<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; Wed Feb 10 2021 19:00:00 GMT-0500 (Eastern Standard Time):</p>

</article>
			
			<footer>
				<hr>
				<p>
					&copy; <a href="https://ewitherington.me">Ethan Witherington</a> 2022
				</p>
			</footer>
		</main>
	</body>

</html>