<!DOCTYPE html>
<html lang=" en-US">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		
	<!-- MathJax disabled on this page -->

		


		<!--[if lt IE 9]>
			<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
		<![endif]-->
		
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Arvo&family=Fira+Mono&family=Open+Sans&display=swap');
		</style>
		<link rel="stylesheet" href="/styles/index.css?v=1657689426778">

		<!-- Code Highlighting -->
		<link rel="stylesheet" href="https://raw.githubusercontent.com/PrismJS/prism-themes/master/themes/prism-one-light.css">
	</head>

	<body>
		<main>
			
			


<article>
	<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; 2021-02-02: Persistence</p>
<h1>Persistence</h1>
<p>What does this registry key do?</p>
<pre><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
</code></pre>
<p>It runs things at startup! If malware authors can create a value in this subkey, they can start their malware when the computer starts.</p>
<h2>AppInit_DLLs</h2>
<p>The ApppInit_DLLs are loaded into every program that uses User32.dll. This is another persistence method, but authors need to be careful - to avoid running multiple copies of the malware, they need to check the name of the process, commonly in <code>DllMain</code>.</p>
<blockquote>
<p>32 means 64 bits - they wanted to keep the same names. 64 means 32 bits, running in the windows for windows subsystem :facepalm:</p>
</blockquote>
<h2>WinLogon Notify</h2>
<p>This is a registry key that is checked when certain events happen:</p>
<ul>
<li>logon</li>
<li>logoff</li>
<li>startup</li>
<li>shutdown</li>
</ul>
<p>It's another persistence method.</p>
<h2>SvcHost DLLs</h2>
<p>Your friendly neighborhood malware might install itself as a service.</p>
<blockquote>
<p>On Linux, it's called a Daemon. Linux Services generally start services</p>
</blockquote>
<p>Services live here:</p>
<pre><code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\&lt;Service Name Goes Here&gt;
</code></pre>
<p>There are a bunch of keys under that service name that define what it is and how to run it.</p>
<p>There are a lot of services - to make group management easier, windows puts a lot of services under a single process: <code>SvcHost</code>. Creating a new group under SvcHost wouldn't be very covert (Each group runs under its own process) - but malware can easily add more DLLs to an existing group.</p>
<h2>&quot;Trojanize&quot; a system binary</h2>
<ol>
<li>At the start of the dll, immediately jump to the evil code</li>
<li>Use <code>pusha</code> to save the state of the registers</li>
<li>No-good sneaky shenanigans</li>
<li>Use <code>popa</code> to put the registers back together</li>
<li>Hand off to the original, non-malicious code</li>
</ol>
<p>We're looking at an example in class:</p>
<ul>
<li>Jump to evil code</li>
<li>Save the registers</li>
<li>call itself, 2 addresses away</li>
<li>Remove the return address, and replace it with the address of <em>more</em> evil code</li>
<li>Call loadLibrary, which loads the more evil code? (Why make it the return address then?)</li>
<li>popa to restore the registers</li>
<li>run the instructions that were overwritten to add the jmp instruction</li>
<li>jump back to the start, normal code resumes</li>
</ul>
<blockquote>
<p>My best guess is that it doesn't know the address of the more evil code - but it can take it's own address (via the call) and then add an offset to it.</p>
</blockquote>
<h2>DLL Load Order Hijacking</h2>
<p>Windows searches for DLLs in a specific order. If a malicious copy is placed in a directory that is searched before the directory with the original, then the malicious one is used.</p>
<h2>IAT: Import Address Table Hooking</h2>
<blockquote>
<p>I missed this section :(</p>
</blockquote>
<h2>Trampoline?</h2>
<ol>
<li>A hooking engine or evil DLL is loaded</li>
<li>The hooking engine overwrites the start of a target function</li>
<li>When the target function is called, it jumps to the malware</li>
<li>Mr. Malware has complete control of the function now, importantly the arguments and return values</li>
<li>Mr. Malware remembers to run the overwritten code before returning</li>
</ol>
<p>The &quot;trampoline&quot; refers to how control execution falls into the malware, then bounces back.</p>
<p>Control, intended for a function, instead goes to the malware, which then jumps back to the function when its done.</p>
<hr>
<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; 2021-02-02: Persistence</p>

</article>
			
			<footer>
				<hr>
				<p>
					&copy; <a href="https://ewitherington.me">Ethan Witherington</a> 2022
				</p>
			</footer>
		</main>
	</body>

</html>