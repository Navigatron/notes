<!DOCTYPE html>
<html lang=" en-US">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		
	<!-- MathJax disabled on this page -->

		


		<!--[if lt IE 9]>
			<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
		<![endif]-->
		
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Arvo&family=Fira+Mono&family=Open+Sans&display=swap');
		</style>
		<link rel="stylesheet" href="/styles/index.css?v=1657689426778">

		<!-- Code Highlighting -->
		<link rel="stylesheet" href="https://raw.githubusercontent.com/PrismJS/prism-themes/master/themes/prism-one-light.css">
	</head>

	<body>
		<main>
			
			


<article>
	<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; 2021-01-28: Intro to x86, lsass, runtime linking</p>
<h1>2021-01-28: Intro to x86, lsass, runtime linking</h1>
<p>Three types of Linking:</p>
<ul>
<li>Static
<ul>
<li>The libraries used are baked into the binary</li>
</ul>
</li>
<li>Dynamic
<ul>
<li>The binary loads the libraries it needs when it starts</li>
</ul>
</li>
<li>Runtime
<ul>
<li>The binary can load libraries as it needs them, during runtime.</li>
</ul>
</li>
</ul>
<p><code>strings</code> and <code>floss</code> can reveal text data inside a binary. If the binary is <em>packed</em> or <em>obfuscated</em>, then only two strings will appear - <code>GetProcAddress</code> and <code>LoadLibraryA</code>.</p>
<h2>Pwdump</h2>
<p>Pwdump no longer works on Windows 10. It used to be able to extract password hashes from windows machines, when injected into the lsass process.</p>
<blockquote>
<p>On windows servers (including domain controllers), passwords are stored in ntds.dit. When a pentester steals this file, you might hear them say &quot;I dumped the dit! Let's get some steak&quot;</p>
</blockquote>
<h2>lsass.exe</h2>
<p>A process in windows that enforces security policy. It verifies users logging in, handles password changes, and creates access tokens.</p>
<h2>KeyLogging</h2>
<ul>
<li>Hooking
<ul>
<li>Asks the windows API to notify the malware whenever a key is pressed</li>
</ul>
</li>
<li>Polling
<ul>
<li>Checks the state of every key on the keyboard</li>
<li>does it again very shortly afterwards</li>
<li><code>GetForegroundWindow</code>, <code>GetKeyState</code>, <code>GetAsyncKeyState</code></li>
</ul>
</li>
</ul>
<p>An extract from a polling keylogger:</p>
<pre><code>call ds:GetForegroundWindow

push 10h ; &quot;10&quot; in hex - virtual key code for shift
call ds:GetKeyState ; takes keycode to check off the stack
; Highest-order bit set means keyDown: 0x8000
; Lowest order means key &quot;toggled&quot; (like capslock): 0x0001
</code></pre>
<h2>x86</h2>
<h3>Operations</h3>
<h4>test</h4>
<p>non-destructive AND between two arguments. If the result is all zeroes, then the zero flag is set.</p>
<h4>jz</h4>
<p>Jumps to a memory address if and only if the zero flag is set.</p>
<h4>cmp o1 o2</h4>
<p>Takes o1 minus 02,</p>
<blockquote>
<p>I'm not sure what flag this sets.</p>
</blockquote>
<h4>jl</h4>
<p>Jump if less than.</p>
<blockquote>
<p>I'm not sure what flag this checks</p>
</blockquote>
<h3>registers</h3>
<ul>
<li>esi: &quot;source index&quot;</li>
<li>eax: &quot;return value&quot;</li>
</ul>
<p>EAX can be split up like this:</p>
<pre><code>+-----------------------------------+
|                EAX                |
+-----------------+-----------------+
|                 |       AX        |
+-----------------+--------+--------+
|                 |   AH   |   AL   |
+--------+--------+--------+--------+
| 8 bits | 8 bits | 8 bits | 8 bits |
+--------+--------+--------+--------+
</code></pre>
<p>EAX itself is the lowest 32 bits of a larger register, <code>RAX</code></p>
<h2>Windows API</h2>
<blockquote>
<p>I should put this into it's own quick-reference file</p>
</blockquote>
<h3>LoadLibraryA</h3>
<p>Takes the filename of the dll off the stack, places the address (once loaded) into <code>esi</code>.</p>
<ul>
<li>Name of DLL pushed: <code>push offset LibFileName</code></li>
<li>Address of LoadLibraryA in esi</li>
<li><code>call esi</code></li>
</ul>
<p>The following example loads the <code>samsrv</code> and <code>advapi32</code> dll's. (This was used by pwdump)</p>
<pre><code>push    offset LibFileName     ; &quot;samsrv.dll&quot;
call    esi ; LoadLibraryA
push    offset aAdvapi32_dll_0 ; &quot;advapi32.dll&quot;
call    esi ; LoadLibraryA
</code></pre>
<h3>GetProcAddress</h3>
<p>Takes two arguments:</p>
<ul>
<li>the name of the function to get (from the dll)</li>
<li>&quot;context&quot;, ebx or ebi, hModule?
<ul>
<li>I think this is the address of the loaded dll that the function is in</li>
</ul>
</li>
</ul>
<h3>GetForegroundWindow</h3>
<h3>GetKeyState</h3>
<p>Takes a virtual keycode, returns if it is down in the highest bit. returns if it is &quot;toggled&quot; in the lowest bit.</p>
<p>If you press and hold a (non-toggleable) key, this will continuously return <code>0x8000</code></p>
<h3>GetAsyncKeyState</h3>
<p>Takes a virtual keycode. Returns if it is down in the highest bit. Returns if it has been newly pressed since the last call in the lowest bit.</p>
<p>This will return <code>0x8001</code></p>
<hr>
<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; 2021-01-28: Intro to x86, lsass, runtime linking</p>

</article>
			
			<footer>
				<hr>
				<p>
					&copy; <a href="https://ewitherington.me">Ethan Witherington</a> 2022
				</p>
			</footer>
		</main>
	</body>

</html>