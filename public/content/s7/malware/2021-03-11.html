<!DOCTYPE html>
<html lang=" en-US">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		
	<!-- MathJax disabled on this page -->

		


		<!--[if lt IE 9]>
			<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
		<![endif]-->
		
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Arvo&family=Fira+Mono&family=Open+Sans&display=swap');
		</style>
		<link rel="stylesheet" href="/styles/index.css?v=1657689426782">

		<!-- Code Highlighting -->
		<link rel="stylesheet" href="https://raw.githubusercontent.com/PrismJS/prism-themes/master/themes/prism-one-light.css">
	</head>

	<body>
		<main>
			
			


<article>
	<p><a href="../../../">Index</a> &gt; <a href="./">malware</a> &gt; Wed Mar 10 2021 19:00:00 GMT-0500 (Eastern Standard Time):</p>
<h1>Wed Mar 10 2021 19:00:00 GMT-0500 (Eastern Standard Time):</h1>
<p>Let's grab that snort rule from last class:</p>
<pre><code>alert tcp $HOME_NET any -&gt; $EXTERNAL_NET $HTTP_PORTS (msg:&quot;TROJAN Malicious User-Agent&quot;; content:&quot;|0d 0a|User-Agent\: Wefa7e&quot;; classtype:trojan-activity; sid:2000001; rev:1;)
</code></pre>
<ul>
<li>Header
<ul>
<li>alert
<ul>
<li>Generate an <em>alert</em> when this rule matches</li>
<li>Could also be <em>log</em></li>
</ul>
</li>
<li>tcp
<ul>
<li>Match only TCP traffic (because http uses tcp)</li>
</ul>
</li>
<li>$HOME_NET any
<ul>
<li>Source IP - the local network</li>
<li>Source Port - <em>any</em> port - the client initiating the connection could use any dynamic port.</li>
</ul>
</li>
<li><code>-&gt;</code> (right-pointing arrow)
<ul>
<li>Traffic direction: outbound</li>
</ul>
</li>
<li>$EXTERNAL_NET $HTTP_PORTS
<ul>
<li>Destination IP - some external network</li>
<li>Destination Port - HTTP / 80</li>
</ul>
</li>
</ul>
</li>
<li>Options
<ul>
<li>Metadata to be stored in logs/alerts
<ul>
<li>msg: A description to be logged</li>
<li>classtype: General rule category</li>
<li>sid: Unique Rule Identifier</li>
<li>rev: Revision of this rule</li>
</ul>
</li>
<li>Further specifiers to match events
<ul>
<li>content: Match the content of the packet payload
<ul>
<li>Hex values between single pipes represent binary; <code>|0d 0a|=\r\n</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>After this rule was submitted to the emerging threats db, researchers found new information, and updated the rule.</p>
<ul>
<li>msg: ET TROJAN WindowsEnterpriseSuite FakeAV Dynamic User-Agent</li>
<li>flow: established,to_server
<ul>
<li>it must be the client initiating the connection</li>
</ul>
</li>
<li>content: <code>|0d 0a|User-Agent\: We</code>
<ul>
<li>Match this content!</li>
</ul>
</li>
<li>isdataat: 6,relative
<ul>
<li>Verify there is data 6 bytes after the last match</li>
</ul>
</li>
<li>content: <code>|0d 0a|</code>
<ul>
<li>Match this!</li>
</ul>
</li>
<li>distance: 0
<ul>
<li>And start looking for this match zero bytes after the last match</li>
<li>By default, it matches anywhere - distance:0 essentially says &quot;match after last match&quot;</li>
</ul>
</li>
<li>pcre: /User-Agent: We[a-z0-9]{4}\x0d\x0a/</li>
<li>reference: link
<ul>
<li>Tells the analyst more about this detection in the alert</li>
</ul>
</li>
</ul>
<p>There will be more updates to this rule - but that's for next class.</p>
<h2>Flow</h2>
<p>The arrow in the rule header matches the source and destination fields of the tcp header.</p>
<p>The to_client and to_server values in the flow field specify which end established the tcp connection.</p>
<p>For example, external -&gt; internal, flow: to_server; matches traffic that is from outside the network, going into the network, and <em>is part of</em> a tcp connection that was started by reaching out to the server. For example, the client initiates an HTTP request, and the response includes some payload - the response would be matched.</p>
<hr>
<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; Wed Mar 10 2021 19:00:00 GMT-0500 (Eastern Standard Time):</p>

</article>
			
			<footer>
				<hr>
				<p>
					&copy; <a href="https://ewitherington.me">Ethan Witherington</a> 2022
				</p>
			</footer>
		</main>
	</body>

</html>