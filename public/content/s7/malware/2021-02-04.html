<!DOCTYPE html>
<html lang=" en-US">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		
	<!-- MathJax disabled on this page -->

		


		<!--[if lt IE 9]>
			<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
		<![endif]-->
		
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Arvo&family=Fira+Mono&family=Open+Sans&display=swap');
		</style>
		<link rel="stylesheet" href="/styles/index.css?v=1657689426778">

		<!-- Code Highlighting -->
		<link rel="stylesheet" href="https://raw.githubusercontent.com/PrismJS/prism-themes/master/themes/prism-one-light.css">
	</head>

	<body>
		<main>
			
			


<article>
	<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; 2021-02-04: Trampolines and Installing Hooks</p>
<h1>Trampolines and Installing Hooks</h1>
<h2>Quick review of trampolines</h2>
<ul>
<li>The beginning of a benign function is overwritten, to pass control to a &quot;callback&quot;</li>
<li>The callback does evil things, before jumping to the trampoline</li>
<li>The trampoline has the overwritten original code to setup the normal function</li>
<li>The trampoline bounces back up to the rest of the original function</li>
</ul>
<p><img src="./images/2021-02-04-trampoline.png" alt=""></p>
<h2>Installing the function hook</h2>
<p><code>LoadLibraryA</code> takes a <em>string</em> (as the name of a library to load) off the stack, and returns the address of the loaded library in <strong>eax</strong>.</p>
<p><code>GetProcAddress</code> takes the address of a library off the stack, then a <em>string</em> function name, and returns the function's address in <strong>eax</strong>.</p>
<p><code>memcpy</code> takes three arguments, in order:</p>
<ul>
<li>Destination address (top of stack, last pushed)</li>
<li>Source address (or is this first???)</li>
<li>Number of bytes to copy</li>
</ul>
<p>It copies <em>number</em> bytes from <em>source</em> to <em>destination</em>.</p>
<p>Using these three functions, malware can create a &quot;jump here&quot; snippet, and install it over the start of a legitimate function.</p>
<blockquote>
<p>In class, the malware snippet used <code>LoadLibraryA</code> and <code>GetProcAddress</code> to get the address of a windows API function that returned valuable information. Netstat uses said function to tell which process is listening on which port. Naturally, the malware wants to hide this.</p>
<p>The malware started with a snippet like this:</p>
<pre><code>mov eax, 0
jmp eax
</code></pre>
<p>Then, the malware used <code>memcpy</code> to overwrite the zero in the snippet with the address of its new, malicious function.</p>
<p>Finally, the malware used <code>memcpy</code> to copy the entire snippet over top of the start of the target windows API function. As a result, netstat can no longer get the information it asks for.</p>
</blockquote>
<blockquote>
<p>Lab 1 is activities 11-2 and 11-3 from Practical Malware Analysis, due February 11th at 11:30pm.</p>
</blockquote>
<hr>
<p><a href="../../../">Index</a> &gt; <a href="./">Malware</a> &gt; 2021-02-04: Trampolines and Installing Hooks</p>

</article>
			
			<footer>
				<hr>
				<p>
					&copy; <a href="https://ewitherington.me">Ethan Witherington</a> 2022
				</p>
			</footer>
		</main>
	</body>

</html>