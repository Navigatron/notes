---
date: 2021-03-11
title: "More SNORT Rules"
---

[Index](../../../index.md) > [malware](./index.md) > {{ page.date }}: {{ page.title }}

# {{ page.date }}: {{ page.title }}

Let's grab that snort rule from last class:

```
alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:"TROJAN Malicious User-Agent"; content:"|0d 0a|User-Agent\: Wefa7e"; classtype:trojan-activity; sid:2000001; rev:1;)
```

- Header
    - alert
        - Generate an *alert* when this rule matches
        - Could also be *log*
    - tcp
        - Match only TCP traffic (because http uses tcp)
    - $HOME_NET any
        - Source IP - the local network
        - Source Port - *any* port - the client initiating the connection could use any dynamic port.
    - `->` (right-pointing arrow)
        - Traffic direction: outbound
    - $EXTERNAL_NET $HTTP_PORTS
        - Destination IP - some external network
        - Destination Port - HTTP / 80
- Options
    - Metadata to be stored in logs/alerts
        - msg: A description to be logged
        - classtype: General rule category
        - sid: Unique Rule Identifier
        - rev: Revision of this rule
    - Further specifiers to match events
        - content: Match the content of the packet payload
            - Hex values between single pipes represent binary; `|0d 0a|=\r\n`

After this rule was submitted to the emerging threats db, researchers found new information, and updated the rule.

- msg: ET TROJAN WindowsEnterpriseSuite FakeAV Dynamic User-Agent
- flow: established,to_server
    - it must be the client initiating the connection
- content: `|0d 0a|User-Agent\: We`
    - Match this content!
- isdataat: 6,relative
    - Verify there is data 6 bytes after the last match
- content: `|0d 0a|`
    - Match this!
- distance: 0
    - And start looking for this match zero bytes after the last match
    - By default, it matches anywhere - distance:0 essentially says "match after last match"
- pcre: /User-Agent\: We[a-z0-9]{4}\x0d\x0a/
- reference: link
    - Tells the analyst more about this detection in the alert

There will be more updates to this rule - but that's for next class.

## Flow

The arrow in the rule header matches the source and destination fields of the tcp header.

The to_client and to_server values in the flow field specify which end established the tcp connection.

For example, external -> internal, flow: to_server; matches traffic that is from outside the network, going into the network, and *is part of* a tcp connection that was started by reaching out to the server. For example, the client initiates an HTTP request, and the response includes some payload - the response would be matched.

---

[Index](../../../index.md) > [Malware](./index.md) > {{ page.date }}: {{ page.title }}
